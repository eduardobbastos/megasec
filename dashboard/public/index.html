<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Security Dashboard</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 50px;
    }

    .card {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 600px;
      text-align: center;
    }

    h1 {
      color: #1a73e8;
      margin-bottom: 20px;
    }

    .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background: #1557b0;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #newScanBtn {
      background: #5f6368;
      display: none;
    }

    #newScanBtn:hover {
      background: #4a4d50;
    }

    #stopScanBtn {
      background: #d93025;
      display: none;
    }

    #stopScanBtn:hover {
      background: #a50e0e;
    }

    .log-window {
      margin-top: 20px;
      background: #1e1e1e;
      color: #00ff00;
      font-family: monospace;
      padding: 15px;
      border-radius: 6px;
      text-align: left;
      height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 13px;
      display: none;
      border: 1px solid #333;
    }

    .status {
      margin-top: 20px;
      color: #5f6368;
    }

    .report-link {
      display: inline-block;
      margin-top: 20px;
      text-decoration: none;
      color: white;
      background: #34a853;
      font-weight: bold;
      border: 1px solid #34a853;
      padding: 10px 20px;
      border-radius: 6px;
    }

    .report-link:hover {
      background: #2d8e47;
    }

    .report-link.hidden {
      display: none;
    }

    div.summary-container {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      width: 100%;
      justify-content: center;
    }

    .summary-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      text-align: center;
      flex: 1;
      border-left: 5px solid #ccc;
    }

    .summary-card h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #555;
    }

    .summary-score {
      font-size: 24px;
      font-weight: bold;
    }

    .risk-high {
      color: #d93025;
    }

    .risk-medium {
      color: #f9ab00;
    }

    .risk-safe {
      color: #188038;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>üõ°Ô∏è Security Control</h1>

    <div class="summary-container">
      <div class="summary-card" style="border-left-color: #1a73e8;">
        <h3>ZAP Alerts</h3>
        <div id="summ-zap" class="summary-score">--</div>
        <small>High/Med</small>
      </div>

    </div>

    <div style="margin-bottom: 20px; width: 100%">
      <label for="urlInput" style="
            display: block;
            text-align: left;
            margin-bottom: 5px;
            color: #555;
          ">Target URL:</label>
      <input type="text" id="urlInput" value="https://secure_web:8443" style="
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
          " />
      <small style="display: block; text-align: left; color: #777; margin-top: 5px">
        For local apps, use <code>host.docker.internal</code> instead of
        <code>localhost</code>.
      </small>
    </div>

    <div class="actions">
      <button id="scanBtn">‚ñ∂ Run/Rerun ZAP Scan</button>
      <button id="fullScanBtn" style="background-color: #d93025;">‚öîÔ∏è Run Full Attack Scan</button>
      <button id="stopScanBtn">‚¨õ Stop Scan</button>
      <button id="newScanBtn">‚Ü∫ New Scan</button>
    </div>

    <div class="info-section"
      style="margin-top: 30px; text-align: left; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
      <h3 style="margin-top: 0; color: #5f6368;">üîç Scan Coverage Information</h3>

      <details style="margin-bottom: 10px;">
        <summary style="font-weight: bold; cursor: pointer; color: #1a73e8;">üåê Web Application Security (ZAP)</summary>
        <p style="margin: 5px 0 0 15px; font-size: 14px; color: #444;">
          Analyzes the running application (`https://web:8443`) for:
        <ul style="margin: 5px 0 0 20px;">
          <li><strong>HTTP Headers:</strong> HSTS, CSP, X-Frame-Options configurations.</li>
          <li><strong>Cookie Security:</strong> HttpOnly, Secure, SameSite flags.</li>
          <li><strong>Injection Attacks:</strong> XSS, SQLi attempts.</li>
          <li><strong>Information Leakage:</strong> Debug comments, private IP disclosure.</li>
        </ul>
        </p>
      </details>

      <div
        style="background: #fff3cd; padding: 10px; border-left: 5px solid #ffc107; margin-top: 10px; font-size: 13px;">
        <strong>‚ö° Tipos de Scan:</strong><br>
        1. <strong>ZAP Baseline (Blue):</strong> R√°pido, passivo (n√£o ataca), ideal para CI/CD e checks r√°pidos.<br>
        2. <strong>Full Attack (Red):</strong> Lento, agressivo, usa AJAX Spider (Chrome) e tenta invadir o site. Use
        com cuidado!
      </div>

      </details>
    </div>

    <div class="log-window" id="logWindow"></div>
    <div class="status" id="statusText">Ready</div>

    <a href="/reports/report.html" target="_blank" id="reportBtn" class="report-link hidden">üìÑ Open ZAP Report</a>

  </div>

  <script>
    async function checkStatus() {
      try {
        const res = await fetch("/api/status");
        const data = await res.json();
        if (data.reportExists && document.getElementById("logWindow").style.display === "none") {
          // Only show report link if we are not in a fresh state
          document.getElementById("reportBtn").classList.remove("hidden");
        }
      } catch (e) { }
    }

    async function updateSummary() {
      try {
        const res = await fetch("/api/summary");
        const data = await res.json();

        const zapScore = document.getElementById("summ-zap");
        const cveScore = document.getElementById("summ-cve");
        const secScore = document.getElementById("summ-sec");

        // ZAP
        zapScore.innerHTML = `<span class="risk-high">${data.zap.high}</span> / <span class="risk-medium">${data.zap.medium}</span>`;

        // CVE & Secrets Removed
      } catch (e) { console.error("Summary fetch failed", e); }
    }

    checkStatus();
    updateSummary();

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("scanBtn").addEventListener("click", () => runScan("zap"));
      document.getElementById("fullScanBtn").addEventListener("click", () => runScan("full"));
      document.getElementById("stopScanBtn").addEventListener("click", stopScan);
      document.getElementById("newScanBtn").addEventListener("click", resetUI);
    });

    async function resetUI() {
      // Call endpoint to delete old reports
      try {
        await fetch("/api/reset", { method: "POST" });
      } catch (e) {
        console.error("Failed to reset reports", e);
      }

      const logWindow = document.getElementById("logWindow");
      const scanBtn = document.getElementById("scanBtn");
      const fullScanBtn = document.getElementById("fullScanBtn");
      const newScanBtn = document.getElementById("newScanBtn");
      const status = document.getElementById("statusText");
      const input = document.getElementById("urlInput");
      const reportBtn = document.getElementById("reportBtn");
      const zapScore = document.getElementById("summ-zap");

      logWindow.style.display = "none";
      logWindow.textContent = "";
      scanBtn.style.display = "inline-block";
      fullScanBtn.style.display = "inline-block";
      scanBtn.disabled = false;
      fullScanBtn.disabled = false;
      newScanBtn.style.display = "none";
      status.textContent = "Ready";
      status.style.color = "#5f6368";
      input.disabled = false;
      reportBtn.classList.add("hidden");

      // Manually reset summary text
      zapScore.innerHTML = "--";
    }

    async function runScan(type) {
      const scanBtn = document.getElementById("scanBtn");
      const fullScanBtn = document.getElementById("fullScanBtn");
      const newScanBtn = document.getElementById("newScanBtn");
      const logWindow = document.getElementById("logWindow");
      const status = document.getElementById("statusText");
      const input = document.getElementById("urlInput");
      const reportBtn = document.getElementById("reportBtn");

      // UI Prep
      scanBtn.disabled = true;
      fullScanBtn.disabled = true;
      input.disabled = true;
      reportBtn.classList.add("hidden");
      stopScanBtn.style.display = "inline-block";

      logWindow.style.display = "block";
      if (type === 'zap') logWindow.textContent = "Initializing ZAP Baseline Scan (Passive)...\n";
      else logWindow.textContent = "Initializing ZAP FULL ATTACK Scan (Active + AJAX, this will take time)...\n";

      status.textContent = "Scanning in progress...";
      status.style.color = "#e37400";

      try {
        const url = input.value;
        let endpoint = `/api/scan?url=${encodeURIComponent(url)}`;
        if (type === 'full') endpoint = `/api/scan-full?url=${encodeURIComponent(url)}`;

        const response = await fetch(endpoint);

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const text = decoder.decode(value);
          logWindow.textContent += text;
          logWindow.scrollTop = logWindow.scrollHeight; // Auto scroll
        }

        status.textContent = "Scan Completed!";
        status.style.color = "green";

        if (type === 'zap' || type === 'full') {
          reportBtn.href = `/reports/report.html?t=${Date.now()}`;
          reportBtn.classList.remove("hidden");
        }

        updateSummary(); // Refresh summary scores

        scanBtn.style.display = "none";
        fullScanBtn.style.display = "none";
        stopScanBtn.style.display = "none";
        newScanBtn.style.display = "inline-block";

      } catch (error) {
        logWindow.textContent += `\n[FATAL ERROR]: ${error.message}`;
        status.textContent = "Error occurred";
        status.style.color = "red";
        scanBtn.disabled = false;
        fullScanBtn.disabled = false;
        stopScanBtn.style.display = "none";
        input.disabled = false;
      }
    }

    async function stopScan() {
      if (!confirm("Are you sure you want to stop the current scan?")) return;

      const logWindow = document.getElementById("logWindow");
      try {
        const res = await fetch("/api/stop-scan", { method: "POST" });
        const data = await res.json();
        logWindow.textContent += `\n[INFO] ${data.message}\n`;
      } catch (e) {
        logWindow.textContent += `\n[ERROR] Failed to stop scan: ${e.message}\n`;
      }
    }
  </script>
</body>

</html>