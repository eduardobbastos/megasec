version: "3"

services:
  web:
    build: .
    container_name: secure_web
    ports:
      - "8085:80"
      - "8443:8443"
    networks:
      - secure_net

  zap:
    image: zaproxy/zap-stable
    container_name: security_scanner
    command: sleep infinity # Keep container running to execute scans manually
    networks:
      - secure_net
    volumes:
      - ./reports:/zap/wrk/:rw
    extra_hosts:
      - "host.docker.internal:host-gateway" # Allow access to localhost apps via this hostname

  dashboard:
    build:
      context: ./dashboard
      network: host
    container_name: security_dashboard
    ports:
      - "8088:3000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # Allow control of sibling containers
      - ./reports:/app/reports # Access reports generated by ZAP
    networks:
      - secure_net

  compliance:
    image: aquasec/trivy
    container_name: security_compliance
    command: image --format template --template "@contrib/html.tpl" -o /reports/cve_report.html secure_template-web:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./reports:/reports
    depends_on:
      - web

  secret_scan:
    image: trufflesecurity/trufflehog:latest
    container_name: security_secrets
    # We mount the current directory to /app to scan the source code
    # We output to a file in /reports using shell redirection
    entrypoint: /bin/sh
    command: -c "trufflehog filesystem /app --json --no-verification > /reports/secrets.json"
    volumes:
      - ./:/app:ro
      - ./reports:/reports
    user: root # Needed to write to mounted volumes sometimes, or we ensure perms

networks:
  secure_net:
